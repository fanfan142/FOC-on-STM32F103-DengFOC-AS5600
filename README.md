# STM32F103 FOC 电机控制项目（DengFOC + AS5600）

> 本项目基于 **STM32F103C8T6** 微控制器，结合 **DengFOC 驱动板（M0 通道）**、**AS5600 磁编码器（I²C 接口）** 及 **2208 无刷电机** 实现完整的 **FOC（磁场定向控制）** 电机控制流程。供学习、调试与二次开发使用。

---

## 📘 目录

- [硬件组成](#硬件组成)
- [引脚与接线说明](#引脚与接线说明)
- [功能概述](#功能概述)
- [控制模式](#控制模式)
- [串口命令说明](#串口命令说明)
- [控制时序与执行频率](#控制时序与执行频率)
- [电流采样与保护机制](#电流采样与保护机制)
- [角度与速度测量](#角度与速度测量)
- [VOFA+ 数据输出](#vofa-数据输出)
- [编译与烧录方法](#编译与烧录方法)
- [快速上手指南](#快速上手指南)
- [项目目录结构](#项目目录结构)
- [调参建议](#调参建议)
- [安全注意事项](#安全注意事项)
- [后续计划](#后续计划)
- [开源协议](#开源协议)

---

## 🧩 硬件组成

| 项目 | 说明 |
|------|------|
| 主控 | STM32F103C8T6（蓝丁板） |
| 驱动 | DengFOC（使用 M0 通道） |
| 电机 | 无刷 2208 电机（7 对极） |
| 编码器 | AS5600 磁角度传感器（I²C） |
| 电源 | 12V 外部供电 |
| 串口 | USART1 → 上位机（USB-TTL） |
| 电流采样 | ADC1 双通道采样（O1_CS、O2_CS） |

---

## 🔌 引脚与接线说明

| 模块 | 引脚定义 | 功能 |
|------|-----------|------|
| PWM 输出 | TIM2_CH1/2/3 | 输出三相 PWM，驱动 DengFOC |
| 电机使能 | PA8 | 拉高后电机使能 |
| 编码器 | PB10 = SCL，PB11 = SDA | AS5600 I²C 连接 |
| 电流采样 | PB0 = ADC1_IN8，PB1 = ADC1_IN9 | 采样两相电流 |
| 串口通信 | PA9 = TX，PA10 = RX | 与上位机通信 |

> CubeMX 中需保持引脚定义一致。

---

## ⚙️ 功能概述

- ✅ **完整 FOC 流程**：Clarke/Park 正逆变换、dq 电流 PI、SVPWM 输出  
- 🧭 **零电角对齐**：自动吸附定位、稳定采样角度  
- 🧠 **开环 / 电流闭环 / 位置闭环 / 速度闭环** 四种模式  
- 🧰 **串口在线参数调试**：命令行式输入设置参数  
- 🧲 **机械角解缠绕 + 速度滤波**  
- ⚡ **过流保护与饱和抗积分**  
- 📊 **VOFA+ 实时波形输出**  
- 🧯 **I²C 总线错误恢复**，防止 AS5600 通信挂死  

---

## 🔄 控制模式

通过串口命令 `cX` 切换模式：

| 模式编号 | 名称 | 说明 |
|-----------|------|------|
| `c1` | 开环速度模式 | 积分电角、输出固定 Uq |
| `c2` | 电流闭环模式 | dq 电流双 PI 控制 |
| `c3` | 位置闭环模式 | 目标位置（rad）→ PID 输出 Uq |
| `c4` | 速度闭环模式 | 目标速度（rad/s）→ PID 输出 Uq |

---

## 💬 串口命令说明

命令格式：以字母+数值组成，可组合输入，用 `\n` 结束。

### 模式与目标
